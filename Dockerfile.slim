# Base: Runtime (Smallest possible)
FROM nvidia/cuda:12.8.0-cudnn-runtime-ubuntu22.04

LABEL authors="onthemove31"
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PATH="/root/comfyui/ComfyUI/.venv/bin:$PATH"

# 1. Install System Dependencies
RUN apt-get update && apt-get install --no-install-recommends -y \
    git curl wget cmake build-essential \
    python3.10 python3-pip python3-dev python3-venv \
    ffmpeg libgl1-mesa-glx libglib2.0-0 \
    openssh-client openssl rsync unzip htop nvtop tmux \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 2. Set Up ComfyUI
WORKDIR /root/comfyui
RUN git clone https://github.com/comfyanonymous/ComfyUI.git ComfyUI
WORKDIR /root/comfyui/ComfyUI

# 3. Create Venv
RUN python3.10 -m venv .venv
RUN . .venv/bin/activate && pip install --no-cache-dir --upgrade pip

# 4. Copy Scripts
# FIXED: Copy to ./ (Current Dir) instead of / (Root)
COPY nodes_list.txt install_nodes.py ./
COPY start_slim.sh /start.sh
RUN chmod +x /start.sh

# 5. Clone Nodes Only (Tiny Image Size)
# FIXED: Removed the leading slash so it uses the file we just copied to ./
RUN python install_nodes.py --clone-only

EXPOSE 8188
ENTRYPOINT ["/start.sh"]